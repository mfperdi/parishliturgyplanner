<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Roboto', 'Arial', sans-serif;
      padding: 0;
      margin: 0;
      background-color: #f8f9fa;
      color: #3c4043;
      line-height: 1.5;
    }

    /* Header */
    .header {
      text-align: center;
      padding: 12px 16px 0 16px;
    }

    .header h3 {
      font-weight: 500;
      font-size: 18px;
      margin: 0;
      color: #1f1f1f;
    }

    .header .subtitle {
      font-size: 11px;
      color: #5f6368;
      margin-top: 2px;
    }

    /* Tab Navigation */
    .tab-bar {
      display: flex;
      border-bottom: 2px solid #e0e0e0;
      background: white;
      padding: 0 4px;
      margin-top: 8px;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .tab-btn {
      flex: 1;
      padding: 10px 4px 8px 4px;
      font-size: 12px;
      font-weight: 500;
      color: #5f6368;
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      cursor: pointer;
      transition: color 0.15s, border-color 0.15s;
      text-align: center;
      white-space: nowrap;
    }

    .tab-btn:hover {
      color: #1a73e8;
      background: #f0f4ff;
    }

    .tab-btn.active {
      color: #1a73e8;
      border-bottom-color: #1a73e8;
    }

    .tab-btn .tab-icon {
      display: block;
      font-size: 16px;
      margin-bottom: 2px;
    }

    /* Tab Content */
    .tab-content {
      display: none;
      padding: 16px;
    }

    .tab-content.active {
      display: block;
    }

    /* Section Cards */
    .card {
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      margin-bottom: 12px;
      overflow: hidden;
    }

    .card-header {
      padding: 10px 14px;
      font-weight: 500;
      font-size: 13px;
      color: #3c4043;
      border-bottom: 1px solid #f1f3f4;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-body {
      padding: 12px 14px;
    }

    /* Quick Access Navigation */
    .quick-access-btns {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 6px;
    }

    .btn-nav {
      padding: 10px 8px;
      font-size: 12px;
      font-weight: 500;
      border: 1px solid #dadce0;
      border-radius: 6px;
      background: white;
      color: #3c4043;
      cursor: pointer;
      transition: all 0.15s ease;
      text-align: center;
    }

    .btn-nav:hover {
      background: #f8f9fa;
      border-color: #1a73e8;
      color: #1a73e8;
    }

    /* Buttons */
    .btn {
      width: 100%;
      padding: 10px 14px;
      font-size: 13px;
      font-weight: 500;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .btn:disabled {
      background-color: #f1f3f4;
      color: #9aa0a6;
      cursor: not-allowed;
    }

    .btn-primary {
      background-color: #1a73e8;
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background-color: #1557b0;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(26, 115, 232, 0.25);
    }

    .btn-secondary {
      background-color: #1e8e3e;
      color: white;
    }

    .btn-secondary:hover:not(:disabled) {
      background-color: #188038;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(30, 142, 62, 0.25);
    }

    .btn-warning {
      background-color: #f9ab00;
      color: #1f1f1f;
    }

    .btn-warning:hover:not(:disabled) {
      background-color: #e8a317;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(249, 171, 0, 0.25);
    }

    .btn-outline {
      background-color: white;
      color: #1a73e8;
      border: 1px solid #dadce0;
    }

    .btn-outline:hover:not(:disabled) {
      background-color: #f8f9fa;
      border-color: #1a73e8;
    }

    .btn-danger {
      background-color: white;
      color: #c5221f;
      border: 1px solid #dadce0;
    }

    .btn-danger:hover:not(:disabled) {
      background-color: #fce8e6;
      border-color: #c5221f;
    }

    /* Form Elements */
    .form-group {
      margin-bottom: 10px;
    }

    .form-label {
      font-size: 12px;
      font-weight: 500;
      color: #3c4043;
      margin-bottom: 4px;
      display: block;
    }

    .form-select, .form-input {
      width: 100%;
      padding: 8px 10px;
      font-size: 13px;
      border: 1px solid #dadce0;
      border-radius: 6px;
      background-color: white;
      color: #3c4043;
      box-sizing: border-box;
    }

    .form-select:focus, .form-input:focus {
      outline: none;
      border-color: #1a73e8;
      box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
    }

    .form-select:disabled, .form-input:disabled {
      background-color: #f1f3f4;
      color: #9aa0a6;
    }

    /* Badges */
    .badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 10px;
      font-weight: 500;
    }

    .badge-pending {
      background: #ea4335;
      color: white;
    }

    .badge-complete {
      background: #137333;
      color: white;
    }

    /* Action row - for side-by-side elements */
    .action-row {
      margin-bottom: 10px;
    }

    .action-row:last-child {
      margin-bottom: 0;
    }

    /* Divider */
    .divider {
      border: none;
      border-top: 1px solid #f1f3f4;
      margin: 12px 0;
    }

    /* Hint text */
    .hint {
      font-size: 11px;
      color: #5f6368;
      margin-top: 6px;
      line-height: 1.4;
    }

    /* Status Messages */
    .status-message {
      margin: 12px 16px;
      padding: 10px 14px;
      border-radius: 6px;
      font-size: 13px;
      display: none;
      align-items: center;
      gap: 8px;
    }

    .status-loading {
      display: flex;
      background-color: #e8f0fe;
      color: #1967d2;
      border: 1px solid #d2e3fc;
    }

    .status-success {
      display: flex;
      background-color: #e6f4ea;
      color: #137333;
      border: 1px solid #c6e6d4;
    }

    .status-error {
      display: flex;
      background-color: #fce8e6;
      color: #c5221f;
      border: 1px solid #f9c6c2;
    }

    /* Loading Spinner */
    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid transparent;
      border-top: 2px solid currentColor;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      flex-shrink: 0;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Hidden */
    .hidden {
      display: none !important;
    }

    /* Accessibility */
    .btn:focus, .tab-btn:focus {
      outline: 2px solid #1a73e8;
      outline-offset: 2px;
    }
  </style>
</head>

<body>
  <!-- Header -->
  <div class="header">
    <h3>Parish Scheduler</h3>
    <div class="subtitle">Liturgical Ministry Management</div>
  </div>

  <!-- Tab Bar -->
  <div class="tab-bar">
    <button class="tab-btn active" data-tab="daily" title="Everyday tasks">
      <span class="tab-icon">&#x1F3E0;</span>
      Daily
    </button>
    <button class="tab-btn" data-tab="schedule" title="Monthly scheduling workflow">
      <span class="tab-icon">&#x1F4C5;</span>
      Schedule
    </button>
    <button class="tab-btn" data-tab="setup" title="One-time setup tasks">
      <span class="tab-icon">&#x2699;&#xFE0F;</span>
      Setup
    </button>
    <button class="tab-btn" data-tab="archive" title="Archive management">
      <span class="tab-icon">&#x1F4E6;</span>
      Archive
    </button>
  </div>

  <!-- ===================== DAILY TAB ===================== -->
  <div class="tab-content active" id="tab-daily">

    <!-- Quick Access -->
    <div class="card">
      <div class="card-header">Quick Access</div>
      <div class="card-body">
        <div class="quick-access-btns">
          <button class="btn-nav" onclick="navigateTo('Volunteers')" title="Go to Volunteers sheet">
            Volunteers
          </button>
          <button class="btn-nav" onclick="navigateTo('Timeoffs')" title="Go to Timeoffs sheet">
            Timeoffs
          </button>
          <button class="btn-nav" onclick="navigateTo('MonthlyView')" title="Go to MonthlyView sheet">
            MonthlyView
          </button>
        </div>
      </div>
    </div>

    <!-- Weekly Email Copy -->
    <div class="card">
      <div class="card-header">Weekly Email</div>
      <div class="card-body">
        <button id="btn-copy-email" class="btn btn-primary">
          Copy Schedule for Email
        </button>

        <!-- Email Text Preview (hidden until generated) -->
        <div id="email-preview-container" style="display: none; margin-top: 10px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
            <span id="email-preview-week" style="font-size: 12px; font-weight: bold; color: #1a73e8;"></span>
            <button id="btn-copy-again" class="btn-nav" style="padding: 4px 8px; font-size: 11px;">
              Copy Again
            </button>
          </div>
          <textarea id="email-preview-text" readonly style="width: 100%; height: 180px; font-family: monospace; font-size: 11px; padding: 8px; border: 1px solid #dadce0; border-radius: 4px; resize: vertical; background: #f8f9fa; box-sizing: border-box;"></textarea>
          <div id="copy-success" style="display: none; margin-top: 6px; padding: 6px 10px; background: #e6f4ea; color: #137333; border-radius: 4px; font-size: 11px; text-align: center;">
            Copied to clipboard! Paste into your email.
          </div>
        </div>

        <div class="hint">Mon-Wed shows current week, Thu-Sun shows next week.</div>
      </div>
    </div>

  </div>

  <!-- ===================== SCHEDULE TAB ===================== -->
  <div class="tab-content" id="tab-schedule">

    <!-- Month Selector -->
    <div class="card">
      <div class="card-header">Month</div>
      <div class="card-body">
        <div class="form-group" style="margin-bottom: 0;">
          <select id="month-select" class="form-select" disabled>
            <option value="">Loading months...</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Generate Schedule -->
    <div class="card">
      <div class="card-header">
        Generate Schedule
        <span id="completion-schedule" class="badge badge-complete hidden">Done</span>
      </div>
      <div class="card-body">
        <div class="hint" style="margin-top: 0; margin-bottom: 8px;">Create unassigned ministry roles for all masses in the selected month.</div>
        <button id="btn-generate-schedule" class="btn btn-primary" disabled>
          Generate Schedule
        </button>
      </div>
    </div>

    <!-- Timeoffs -->
    <div class="card">
      <div class="card-header">
        Timeoffs
        <span id="timeoff-badge" class="badge badge-pending hidden">0 pending</span>
        <span id="completion-timeoffs" class="badge badge-complete hidden">Done</span>
      </div>
      <div class="card-body">
        <div class="action-row">
          <button id="btn-update-form" class="btn btn-outline" disabled>
            Update Timeoff Form
          </button>
        </div>
        <div class="action-row">
          <button id="btn-review-timeoffs" class="btn btn-outline" disabled>
            Review Timeoffs
          </button>
        </div>
      </div>
    </div>

    <!-- Auto-Assign -->
    <div class="card">
      <div class="card-header">
        Auto-Assign Volunteers
        <span id="completion-assignment" class="badge badge-complete hidden">Done</span>
      </div>
      <div class="card-body">
        <div class="hint" style="margin-top: 0; margin-bottom: 8px;">Assign qualified volunteers to ministry roles based on availability and preferences.</div>
        <button id="btn-auto-assign" class="btn btn-primary" disabled>
          Auto-Assign Volunteers
        </button>
      </div>
    </div>

    <!-- Custom Print -->
    <div class="card">
      <div class="card-header">
        Print Schedule
        <span id="completion-custom-print" class="badge badge-complete hidden">Done</span>
      </div>
      <div class="card-body">
        <div class="form-group">
          <label for="custom-print-month" class="form-label">Month to Print</label>
          <select id="custom-print-month" class="form-select" disabled>
            <option value="">Select month...</option>
          </select>
        </div>
        <div class="form-group">
          <label for="custom-print-ministry" class="form-label">Filter by Ministry</label>
          <select id="custom-print-ministry" class="form-select" disabled>
            <option value="All Ministries">All Ministries</option>
          </select>
        </div>
        <div class="form-group">
          <label for="custom-print-sheet-name" class="form-label">Output Sheet Name</label>
          <input type="text" id="custom-print-sheet-name" class="form-input" disabled
                 placeholder="e.g., Lector Feb 2026">
        </div>
        <button id="btn-custom-print" class="btn btn-outline" disabled>
          Generate Print Schedule
        </button>
      </div>
    </div>

    <!-- Publish Ministry -->
    <div class="card">
      <div class="card-header">
        Publish Schedule
        <span id="completion-publish" class="badge badge-complete hidden">Done</span>
      </div>
      <div class="card-body">
        <div class="form-group">
          <label for="publish-ministry-filter" class="form-label">Ministry to Publish</label>
          <select id="publish-ministry-filter" class="form-select" disabled>
            <option value="">Select ministry...</option>
          </select>
        </div>
        <button id="btn-publish-ministry" class="btn btn-secondary" disabled>
          Publish Selected Ministry
        </button>
      </div>
    </div>

  </div>

  <!-- ===================== SETUP TAB ===================== -->
  <div class="tab-content" id="tab-setup">

    <div class="card">
      <div class="card-header">
        Generate Liturgical Calendar
        <span id="completion-calendar" class="badge badge-complete hidden">Done</span>
      </div>
      <div class="card-body">
        <div class="hint" style="margin-top: 0; margin-bottom: 8px;">Run once per year to create the liturgical calendar for all 12 months.</div>
        <button id="btn-generate-calendar" class="btn btn-warning">
          Generate Calendar
        </button>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        Validate Data
        <span id="completion-validation" class="badge badge-complete hidden">Done</span>
      </div>
      <div class="card-body">
        <div class="hint" style="margin-top: 0; margin-bottom: 8px;">Check configuration, volunteers, and mass templates for errors before scheduling.</div>
        <button id="btn-validate" class="btn btn-warning">
          Validate Data
        </button>
      </div>
    </div>

  </div>

  <!-- ===================== ARCHIVE TAB ===================== -->
  <div class="tab-content" id="tab-archive">

    <div class="card">
      <div class="card-header">Year-End Archive</div>
      <div class="card-body">
        <div class="hint" style="margin-top: 0; margin-bottom: 8px;">Create an archive file for the completed year's data.</div>
        <button id="btn-archive" class="btn btn-outline">
          Archive Current Year
        </button>
      </div>
    </div>

    <div class="card">
      <div class="card-header">View Archives</div>
      <div class="card-body">
        <div class="hint" style="margin-top: 0; margin-bottom: 8px;">Access previous years' archived data.</div>
        <button id="btn-view-archives" class="btn btn-outline">
          View Archives
        </button>
      </div>
    </div>

    <div class="card">
      <div class="card-header">Clear Old Data</div>
      <div class="card-body">
        <div class="hint" style="margin-top: 0; margin-bottom: 8px;">Remove old data to start a new year fresh. This is destructive.</div>
        <button id="btn-clear-data" class="btn btn-danger">
          Clear Old Data
        </button>
      </div>
    </div>

  </div>

  <!-- Status Message (shared across all tabs) -->
  <div id="status-message" class="status-message" role="status" aria-live="polite"></div>

  <script>
    // ========================
    // Tab Switching
    // ========================
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');

    tabButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const targetTab = btn.getAttribute('data-tab');

        // Update active tab button
        tabButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        // Show target tab content
        tabContents.forEach(tc => tc.classList.remove('active'));
        document.getElementById('tab-' + targetTab).classList.add('active');

        // Clear status message when switching tabs
        statusMessage.className = 'status-message hidden';
      });
    });

    // ========================
    // Element References
    // ========================

    // Month selector (Schedule tab)
    const monthSelect = document.getElementById('month-select');

    // Schedule tab buttons
    const btnGenerateSchedule = document.getElementById('btn-generate-schedule');
    const btnUpdateForm = document.getElementById('btn-update-form');
    const btnReviewTimeoffs = document.getElementById('btn-review-timeoffs');
    const btnAutoAssign = document.getElementById('btn-auto-assign');

    // Custom Print (Schedule tab)
    const customPrintMonth = document.getElementById('custom-print-month');
    const customPrintMinistry = document.getElementById('custom-print-ministry');
    const customPrintSheetName = document.getElementById('custom-print-sheet-name');
    const btnCustomPrint = document.getElementById('btn-custom-print');

    // Publish (Schedule tab)
    const publishMinistryFilter = document.getElementById('publish-ministry-filter');
    const btnPublishMinistry = document.getElementById('btn-publish-ministry');

    // Daily tab
    const btnCopyEmail = document.getElementById('btn-copy-email');
    const btnCopyAgain = document.getElementById('btn-copy-again');
    const emailPreviewContainer = document.getElementById('email-preview-container');
    const emailPreviewWeek = document.getElementById('email-preview-week');
    const emailPreviewText = document.getElementById('email-preview-text');
    const copySuccess = document.getElementById('copy-success');

    // Setup tab
    const btnGenerateCalendar = document.getElementById('btn-generate-calendar');
    const btnValidate = document.getElementById('btn-validate');

    // Archive tab
    const btnArchive = document.getElementById('btn-archive');
    const btnViewArchives = document.getElementById('btn-view-archives');
    const btnClearData = document.getElementById('btn-clear-data');

    // Badges
    const timeoffBadge = document.getElementById('timeoff-badge');

    // Status
    const statusMessage = document.getElementById('status-message');

    // All buttons that should be disabled during operations
    let allButtons;

    // State
    let pendingTimeoffs = 0;

    // ========================
    // Quick Access Navigation
    // ========================
    function navigateTo(sheetName) {
      google.script.run
        .withSuccessHandler(() => {})
        .withFailureHandler((err) => {
          console.log('Navigate to "' + sheetName + '" failed:', err.message || err);
        })
        .ADMIN_navigateToSheet(sheetName);
    }

    // ========================
    // Button State Management
    // ========================
    function updateButtonStates() {
      const hasCalendar = monthSelect.options.length > 1;
      const hasMonthSelected = monthSelect.value !== '';

      // Schedule tab - month selector
      monthSelect.disabled = !hasCalendar;

      // Schedule tab - main actions (require month selection)
      btnGenerateSchedule.disabled = !hasCalendar || !hasMonthSelected;
      btnUpdateForm.disabled = !hasCalendar || !hasMonthSelected;
      btnReviewTimeoffs.disabled = !hasCalendar || !hasMonthSelected;
      btnAutoAssign.disabled = !hasCalendar || !hasMonthSelected;

      // Custom Print (requires month + sheet name)
      customPrintMonth.disabled = !hasCalendar;
      customPrintMinistry.disabled = !hasCalendar;
      customPrintSheetName.disabled = !hasCalendar;
      const hasCustomPrintMonth = customPrintMonth.value !== '';
      const hasCustomPrintSheetName = customPrintSheetName.value.trim() !== '';
      btnCustomPrint.disabled = !hasCalendar || !hasCustomPrintMonth || !hasCustomPrintSheetName;

      // Publish (requires month + ministry selected)
      publishMinistryFilter.disabled = !hasCalendar || !hasMonthSelected;
      const hasMinistrySelected = publishMinistryFilter.value !== '';
      btnPublishMinistry.disabled = !hasCalendar || !hasMonthSelected || !hasMinistrySelected;

      // Daily tab - email copy (always enabled after calendar exists)
      btnCopyEmail.disabled = !hasCalendar;

      updateBadges();
    }

    function updateBadges() {
      if (pendingTimeoffs > 0) {
        timeoffBadge.textContent = pendingTimeoffs + ' pending';
        timeoffBadge.classList.remove('hidden');
      } else {
        timeoffBadge.classList.add('hidden');
      }
    }

    function refreshWorkflowData() {
      if (monthSelect.value) {
        google.script.run
          .withSuccessHandler((count) => {
            pendingTimeoffs = count || 0;
            updateBadges();
          })
          .withFailureHandler(() => {
            pendingTimeoffs = 0;
            updateBadges();
          })
          .getPendingTimeoffsCount();
      }
    }

    // ========================
    // Completion Badges
    // ========================
    function markStepComplete(stepId) {
      const badge = document.getElementById('completion-' + stepId);
      if (badge) {
        badge.classList.remove('hidden');
      }
    }

    // ========================
    // Initialization
    // ========================
    window.addEventListener('load', () => {
      allButtons = [
        btnGenerateCalendar, btnValidate,
        btnGenerateSchedule, btnUpdateForm, btnReviewTimeoffs, btnAutoAssign,
        btnCustomPrint, btnCopyEmail,
        btnPublishMinistry,
        btnArchive, btnViewArchives, btnClearData
      ];

      // Load month data for schedule tab
      google.script.run
        .withSuccessHandler(onMonthsLoaded)
        .withFailureHandler((error) => showError(error, 'calendar'))
        .getMonthsForSidebar();

      // Load ministries for filter dropdowns
      google.script.run
        .withSuccessHandler(onMinistriesLoaded)
        .withFailureHandler((error) => console.error('Failed to load ministries:', error))
        .getActiveMinistries();

      // Load months for custom print dropdown
      google.script.run
        .withSuccessHandler(onCustomPrintMonthsLoaded)
        .withFailureHandler((error) => console.error('Failed to load custom print months:', error))
        .getNext12Months();
    });

    // ========================
    // Data Load Handlers
    // ========================
    function onMonthsLoaded(months) {
      if (months.length === 0) {
        monthSelect.innerHTML = '<option value="">No calendar found</option>';
        showError({message: "Generate the liturgical calendar first (Setup tab)."}, 'calendar');
        return;
      }

      monthSelect.innerHTML = '<option value="">Select a month...</option>';
      months.forEach(monthObj => {
        const option = document.createElement('option');
        option.value = monthObj.value;
        option.textContent = monthObj.display;
        monthSelect.appendChild(option);
      });

      updateButtonStates();
    }

    function onMinistriesLoaded(ministries) {
      // Custom print ministry filter
      customPrintMinistry.innerHTML = '<option value="All Ministries">All Ministries</option>';
      // Publish ministry filter
      publishMinistryFilter.innerHTML = '<option value="">Select ministry...</option>';

      ministries.forEach(ministry => {
        const opt1 = document.createElement('option');
        opt1.value = ministry;
        opt1.textContent = ministry;
        customPrintMinistry.appendChild(opt1);

        const opt2 = document.createElement('option');
        opt2.value = ministry;
        opt2.textContent = ministry;
        publishMinistryFilter.appendChild(opt2);
      });

      updateButtonStates();
    }

    function onCustomPrintMonthsLoaded(months) {
      customPrintMonth.innerHTML = '<option value="">Select month...</option>';
      months.forEach(monthObj => {
        const option = document.createElement('option');
        option.value = monthObj.value;
        option.textContent = monthObj.display;
        customPrintMonth.appendChild(option);
      });
    }

    // ========================
    // Month Selection
    // ========================
    monthSelect.addEventListener('change', () => {
      updateButtonStates();
      refreshWorkflowData();
    });

    // ========================
    // DAILY TAB: Event Handlers
    // ========================

    // Copy Schedule for Email
    btnCopyEmail.addEventListener('click', () => {
      showLoading('Generating schedule for email...');

      google.script.run
        .withSuccessHandler((result) => {
          emailPreviewText.value = result.text;
          emailPreviewWeek.textContent = result.weekString;
          emailPreviewContainer.style.display = 'block';
          copyScheduleToClipboard(result.text);
          statusMessage.className = 'status-message hidden';
          updateButtonStates();
        })
        .withFailureHandler((error) => showError(error, 'print'))
        .getScheduleForEmailCopy({});
    });

    btnCopyAgain.addEventListener('click', () => {
      copyScheduleToClipboard(emailPreviewText.value);
    });

    function copyScheduleToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        copySuccess.style.display = 'block';
        setTimeout(() => { copySuccess.style.display = 'none'; }, 3000);
      }).catch(() => {
        emailPreviewText.select();
        emailPreviewText.setSelectionRange(0, 99999);
        try {
          document.execCommand('copy');
          copySuccess.style.display = 'block';
          setTimeout(() => { copySuccess.style.display = 'none'; }, 3000);
        } catch (e) {
          showError({ message: 'Could not copy. Please select the text manually.' }, 'print');
        }
      });
    }

    // ========================
    // SCHEDULE TAB: Event Handlers
    // ========================

    // Generate Schedule
    btnGenerateSchedule.addEventListener('click', () => {
      const selectedMonth = monthSelect.value;
      if (!selectedMonth) return;

      const selectedText = monthSelect.options[monthSelect.selectedIndex].text;
      const message = "Are you sure you want to generate the schedule for " + selectedText + "?\n\n" +
                      "This will delete ALL existing assignments for this month and start over.\n\n" +
                      "This action cannot be undone.";

      if (confirm(message)) {
        showLoading('Generating ministry roles for ' + selectedText + '...');

        google.script.run
          .withSuccessHandler((msg) => {
            showSuccess(msg.replace(selectedMonth, selectedText));
            markStepComplete('schedule');
            refreshWorkflowData();
          })
          .withFailureHandler((error) => showError(error, 'schedule'))
          .triggerScheduleGeneration(selectedMonth);
      }
    });

    // Update Timeoff Form
    btnUpdateForm.addEventListener('click', () => {
      const selectedMonth = monthSelect.value;
      if (!selectedMonth) return;

      const selectedText = monthSelect.options[monthSelect.selectedIndex].text;
      showLoading('Updating timeoff form for ' + selectedText + '...');

      google.script.run
        .withSuccessHandler((msg) => {
          showSuccess(msg);
          markStepComplete('timeoffs');
        })
        .withFailureHandler((error) => showError(error, 'form-update'))
        .TIMEOFFS_updateFormForMonth(selectedMonth);
    });

    // Review Timeoffs
    btnReviewTimeoffs.addEventListener('click', () => {
      const selectedMonth = monthSelect.value;
      if (!selectedMonth) return;

      showLoading('Loading timeoff requests...');

      google.script.run
        .withSuccessHandler((msg) => {
          showSuccess(msg);
          markStepComplete('timeoffs');
          refreshWorkflowData();
        })
        .withFailureHandler((error) => showError(error, 'timeoffs'))
        .reviewTimeoffs(selectedMonth);
    });

    // Auto-Assign
    btnAutoAssign.addEventListener('click', () => {
      const selectedMonth = monthSelect.value;
      if (!selectedMonth) return;

      const selectedText = monthSelect.options[monthSelect.selectedIndex].text;
      showLoading('Auto-assigning volunteers for ' + selectedText + '...');

      google.script.run
        .withSuccessHandler((msg) => {
          showSuccess(msg.replace(selectedMonth, selectedText));
          markStepComplete('assignment');
          refreshWorkflowData();
        })
        .withFailureHandler((error) => showError(error, 'assignment'))
        .triggerAssignment(selectedMonth);
    });

    // Custom Print
    btnCustomPrint.addEventListener('click', () => {
      const selectedMonth = customPrintMonth.value;
      const selectedMinistry = customPrintMinistry.value;
      const sheetName = customPrintSheetName.value.trim();

      if (!selectedMonth) {
        showError({ message: 'Please select a month to print' }, 'print');
        return;
      }
      if (!sheetName) {
        showError({ message: 'Please enter an output sheet name' }, 'print');
        return;
      }

      showLoading('Generating print schedule: ' + sheetName + '...');

      google.script.run
        .withSuccessHandler((result) => {
          if (result.success) {
            showSuccess(result.message);
            markStepComplete('custom-print');
            customPrintMonth.value = '';
            customPrintSheetName.value = '';
          } else {
            showError({ message: result.error }, 'print');
          }
        })
        .withFailureHandler((error) => showError(error, 'print'))
        .generateCustomPrint(selectedMonth, selectedMinistry, sheetName);
    });

    // Custom Print auto-suggest sheet name
    function updateCustomPrintSheetName() {
      const month = customPrintMonth.value;
      const ministry = customPrintMinistry.value;

      if (month && customPrintSheetName.value.trim() === '') {
        const [yr, mo] = month.split('-').map(Number);
        const shortMonth = new Date(yr, mo - 1, 1).toLocaleDateString('en-US', { month: 'short' });
        const monthText = shortMonth + ' ' + yr;
        const ministryText = ministry && ministry !== 'All Ministries' ? ministry + ' ' : '';
        customPrintSheetName.value = ministryText + monthText;
      }
    }

    customPrintMonth.addEventListener('change', () => {
      updateCustomPrintSheetName();
      updateButtonStates();
    });

    customPrintMinistry.addEventListener('change', () => {
      updateCustomPrintSheetName();
      updateButtonStates();
    });

    customPrintSheetName.addEventListener('input', () => {
      updateButtonStates();
    });

    // Publish Ministry
    btnPublishMinistry.addEventListener('click', () => {
      const selectedMonth = monthSelect.value;
      const selectedMinistry = publishMinistryFilter.value;
      if (!selectedMonth || !selectedMinistry) return;

      const selectedText = monthSelect.options[monthSelect.selectedIndex].text;
      showLoading('Publishing ' + selectedMinistry + ' schedule for ' + selectedText + '...');

      google.script.run
        .withSuccessHandler((msg) => {
          showSuccess(msg);
          markStepComplete('publish');
        })
        .withFailureHandler((error) => showError(error, 'publish'))
        .PUBLISH_syncMonthlyViewToPublic(selectedMonth, { ministryFilter: [selectedMinistry] });
    });

    publishMinistryFilter.addEventListener('change', () => {
      updateButtonStates();
    });

    // ========================
    // SETUP TAB: Event Handlers
    // ========================

    btnGenerateCalendar.addEventListener('click', () => {
      if (!confirm('This will regenerate the entire liturgical calendar. Any manual adjustments will be lost. Continue?')) {
        return;
      }

      showLoading('Generating liturgical calendar...');

      google.script.run
        .withSuccessHandler((msg) => {
          showSuccess(msg);
          markStepComplete('calendar');
          // Refresh month list after calendar generation
          monthSelect.innerHTML = '<option value="">Reloading months...</option>';
          google.script.run
            .withSuccessHandler(onMonthsLoaded)
            .withFailureHandler((error) => showError(error, 'calendar'))
            .getMonthsForSidebar();
        })
        .withFailureHandler((error) => showError(error, 'calendar'))
        .triggerCalendarGeneration();
    });

    btnValidate.addEventListener('click', () => {
      showLoading('Validating data...');

      google.script.run
        .withSuccessHandler((msg) => {
          showSuccess(msg);
          markStepComplete('validation');
        })
        .withFailureHandler((error) => showError(error, 'validation'))
        .showDataValidation();
    });

    // ========================
    // ARCHIVE TAB: Event Handlers
    // ========================

    btnArchive.addEventListener('click', () => {
      showLoading('Creating archive file...');
      google.script.run
        .withSuccessHandler(() => showSuccess('Archive created successfully!'))
        .withFailureHandler((error) => showError(error, 'archive'))
        .ARCHIVE_promptArchiveCurrentYear();
    });

    btnViewArchives.addEventListener('click', () => {
      showLoading('Loading archives...');
      google.script.run
        .withSuccessHandler(() => showSuccess('Archives loaded'))
        .withFailureHandler((error) => showError(error, 'archive'))
        .ARCHIVE_showArchiveList();
    });

    btnClearData.addEventListener('click', () => {
      showLoading('Clearing old data...');
      google.script.run
        .withSuccessHandler(() => showSuccess('Data cleared successfully'))
        .withFailureHandler((error) => showError(error, 'archive'))
        .ARCHIVE_promptClearOldData();
    });

    // ========================
    // Status Messages
    // ========================
    function showLoading(message) {
      statusMessage.className = 'status-message status-loading';
      statusMessage.innerHTML = '<div class="spinner"></div><span>' + message + '</span>';
      statusMessage.setAttribute('aria-busy', 'true');
      allButtons.forEach(btn => btn.disabled = true);
    }

    function showSuccess(message) {
      statusMessage.className = 'status-message status-success';
      statusMessage.innerHTML = '<span>&#x2713;</span><span>' + message + '</span>';
      statusMessage.setAttribute('aria-busy', 'false');
      updateButtonStates();

      setTimeout(() => {
        if (statusMessage.classList.contains('status-success')) {
          statusMessage.className = 'status-message hidden';
        }
      }, 5000);
    }

    function showError(error, context) {
      let errorMsg = error.message || error;
      let helpText = '';

      switch(context) {
        case 'calendar':
          helpText = '<br><br><strong>Troubleshooting:</strong><br>' +
                     '&bull; Check Config sheet has "Year to Schedule" set<br>' +
                     '&bull; Verify SaintsCalendar sheet exists<br>' +
                     '&bull; Check CalendarOverrides for conflicts';
          break;
        case 'validation':
          helpText = '<br><br><strong>Tip:</strong> Check the error details above to identify which sheet needs fixing';
          break;
        case 'schedule':
          helpText = '<br><br><strong>Troubleshooting:</strong><br>' +
                     '&bull; Verify MassTemplates sheet has templates<br>' +
                     '&bull; Check WeeklyMasses/MonthlyMasses/YearlyMasses sheets<br>' +
                     '&bull; Ensure selected month is in configured year';
          break;
        case 'form-update':
          helpText = '<br><br><strong>Troubleshooting:</strong><br>' +
                     '&bull; Verify schedule was generated for this month<br>' +
                     '&bull; Check Google Form ID in Config sheet<br>' +
                     '&bull; Ensure proper OAuth permissions for Forms API';
          break;
        case 'timeoffs':
          helpText = '<br><br><strong>Tip:</strong> Verify Timeoffs sheet exists and has the correct columns';
          break;
        case 'assignment':
          helpText = '<br><br><strong>Troubleshooting:</strong><br>' +
                     '&bull; Ensure Volunteers sheet has active volunteers<br>' +
                     '&bull; Check volunteers have ministry roles assigned<br>' +
                     '&bull; Verify schedule was generated first';
          break;
        case 'print':
          helpText = '<br><br><strong>Troubleshooting:</strong><br>' +
                     '&bull; Verify schedule was generated for this month<br>' +
                     '&bull; Check LiturgicalCalendar sheet exists<br>' +
                     '&bull; Ensure assignments were created';
          break;
        case 'publish':
          helpText = '<br><br><strong>Troubleshooting:</strong><br>' +
                     '&bull; Verify schedule was generated and assigned<br>' +
                     '&bull; Check publish configuration in Config sheet';
          break;
        case 'archive':
          helpText = '<br><br><strong>Tip:</strong> Check that the year data exists before archiving';
          break;
      }

      statusMessage.className = 'status-message status-error';
      statusMessage.innerHTML = '<span>&#x26A0;</span><span>Error: ' + errorMsg + helpText + '</span>';
      statusMessage.setAttribute('aria-busy', 'false');
      updateButtonStates();
    }

  </script>
</body>
</html>
