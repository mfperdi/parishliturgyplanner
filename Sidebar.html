<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  
  <style>
    body {
      font-family: 'Roboto', 'Arial', sans-serif;
      padding: 16px;
      margin: 0;
      background-color: #f8f9fa;
      color: #3c4043;
      line-height: 1.5;
    }
    
    /* Header */
    .header {
      text-align: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .header h3 {
      font-weight: 500;
      font-size: 20px;
      margin: 0;
      color: #1f1f1f;
    }
    
    .header .subtitle {
      font-size: 12px;
      color: #5f6368;
      margin-top: 4px;
    }
    
    /* Phase Progress Indicator */
    .phase-progress {
      display: flex;
      justify-content: space-between;
      margin-bottom: 24px;
      padding: 16px;
      background: white;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }
    
    .phase-step {
      flex: 1;
      text-align: center;
      font-size: 12px;
      color: #5f6368;
      position: relative;
    }
    
    .phase-step.completed {
      color: #137333;
      font-weight: 500;
    }
    
    .phase-step.active {
      color: #1967d2;
      font-weight: 500;
    }
    
    .phase-step::after {
      content: '';
      position: absolute;
      top: -6px;
      left: 50%;
      transform: translateX(-50%);
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #e0e0e0;
    }
    
    .phase-step.completed::after {
      background: #137333;
    }
    
    .phase-step.active::after {
      background: #1967d2;
    }
    
    /* Phase Sections */
    .phase-container {
      margin-bottom: 24px;
    }
    
    .phase-header {
      background: linear-gradient(135deg, #1a73e8, #1557b0);
      color: white;
      padding: 12px 16px;
      border-radius: 8px 8px 0 0;
      font-weight: 500;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .phase-header.setup {
      background: linear-gradient(135deg, #f9ab00, #e8a317);
      color: #1f1f1f;
    }
    
    .phase-header.completion {
      background: linear-gradient(135deg, #1e8e3e, #188038);
    }
    
    .phase-content {
      background: white;
      border: 1px solid #e0e0e0;
      border-top: none;
      border-radius: 0 0 8px 8px;
      padding: 0;
    }
    
    .phase-content.disabled {
      opacity: 0.6;
      pointer-events: none;
    }
    
    /* Step Items */
    .step-item {
      padding: 16px;
      border-bottom: 1px solid #f1f3f4;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .step-item:last-child {
      border-bottom: none;
    }
    
    .step-item.disabled {
      opacity: 0.5;
      pointer-events: none;
    }
    
    .step-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
      color: white;
      flex-shrink: 0;
    }
    
    .step-content {
      flex: 1;
      min-width: 0;
    }
    
    .step-title {
      font-weight: 500;
      font-size: 14px;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .step-description {
      font-size: 12px;
      color: #5f6368;
      line-height: 1.4;
    }
    
    .step-badge {
      background: #ea4335;
      color: white;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 10px;
      font-weight: 500;
    }
    
    .step-badge.info {
      background: #1a73e8;
    }
    
    /* Buttons */
    .btn {
      width: 100%;
      padding: 10px 14px;
      font-size: 13px;
      font-weight: 500;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      margin-top: 8px;
    }
    
    .btn:disabled {
      background-color: #f1f3f4;
      color: #9aa0a6;
      cursor: not-allowed;
    }
    
    .btn-primary {
      background-color: #1a73e8;
      color: white;
    }
    
    .btn-primary:hover:not(:disabled) {
      background-color: #1557b0;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(26, 115, 232, 0.25);
    }
    
    .btn-secondary {
      background-color: #1e8e3e;
      color: white;
    }
    
    .btn-secondary:hover:not(:disabled) {
      background-color: #188038;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(30, 142, 62, 0.25);
    }
    
    .btn-warning {
      background-color: #f9ab00;
      color: #1f1f1f;
    }
    
    .btn-warning:hover:not(:disabled) {
      background-color: #e8a317;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(249, 171, 0, 0.25);
    }
    
    .btn-outline {
      background-color: white;
      color: #1a73e8;
      border: 1px solid #dadce0;
    }
    
    .btn-outline:hover:not(:disabled) {
      background-color: #f8f9fa;
      border-color: #1a73e8;
    }
    
    /* Form Elements */
    .form-group {
      margin-bottom: 12px;
    }
    
    .form-label {
      font-size: 12px;
      font-weight: 500;
      color: #3c4043;
      margin-bottom: 4px;
      display: block;
    }
    
    .form-select {
      width: 100%;
      padding: 8px 10px;
      font-size: 13px;
      border: 1px solid #dadce0;
      border-radius: 6px;
      background-color: white;
      color: #3c4043;
      box-sizing: border-box;
    }
    
    .form-select:focus {
      outline: none;
      border-color: #1a73e8;
      box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
    }
    
    .form-select:disabled {
      background-color: #f1f3f4;
      color: #9aa0a6;
    }
    
    /* Status Messages */
    .status-message {
      margin-top: 20px;
      padding: 12px 16px;
      border-radius: 6px;
      font-size: 13px;
      display: none;
      align-items: center;
      gap: 8px;
    }
    
    .status-loading {
      display: flex;
      background-color: #e8f0fe;
      color: #1967d2;
      border: 1px solid #d2e3fc;
    }
    
    .status-success {
      display: flex;
      background-color: #e6f4ea;
      color: #137333;
      border: 1px solid #c6e6d4;
    }
    
    .status-error {
      display: flex;
      background-color: #fce8e6;
      color: #c5221f;
      border: 1px solid #f9c6c2;
    }
    
    /* Loading Spinner */
    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid transparent;
      border-top: 2px solid currentColor;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Hidden elements */
    .hidden {
      display: none !important;
    }
    
    /* Accessibility */
    .btn:focus {
      outline: 2px solid #1a73e8;
      outline-offset: 2px;
    }
  </style>
</head>

<body>
  <div class="header">
    <h3>Parish Scheduler</h3>
    <div class="subtitle">Liturgical Ministry Management</div>
  </div>

  <div class="phase-progress">
    <div class="phase-step" id="phase-setup">Setup</div>
    <div class="phase-step" id="phase-scheduling">Scheduling</div>
    <div class="phase-step" id="phase-completion">Completion</div>
  </div>

  <div class="phase-container">
    <div class="phase-header setup">
      <span>‚öôÔ∏è</span>
      <span>Initial Setup</span>
    </div>
    <div class="phase-content" id="phase-setup-content">
      
      <div class="step-item">
        <div class="step-icon" style="background-color: #f9ab00;">1</div>
        <div class="step-content">
          <div class="step-title">Generate Liturgical Calendar</div>
          <div class="step-description">Run once per year to create the complete liturgical calendar</div>
          <button id="btn-admin" class="btn btn-warning" aria-label="Generate liturgical calendar for the entire year">
            Generate Calendar
          </button>
        </div>
      </div>
      
    </div>
  </div>

  <div class="phase-container">
    <div class="phase-header">
      <span>üìÖ</span>
      <span>Monthly Scheduling</span>
    </div>
    <div class="phase-content disabled" id="phase-scheduling-content">
      
      <div class="step-item">
        <div class="step-icon" style="background-color: #1a73e8;">2</div>
        <div class="step-content">
          <div class="step-title">Select Month</div>
          <div class="step-description">Choose which month to schedule</div>
          <div class="form-group">
            <label for="month-select" class="form-label">Month to Schedule</label>
            <select id="month-select" class="form-select" disabled>
              <option value="">Loading months...</option>
            </select>
          </div>
        </div>
      </div>
      
      <div class="step-item">
        <div class="step-icon" style="background-color: #1a73e8;">3</div>
        <div class="step-content">
          <div class="step-title">Generate Schedule</div>
          <div class="step-description">Create unassigned ministry roles for all masses</div>
          <button id="btn-step1" class="btn btn-primary" disabled>
            Generate Schedule
          </button>
        </div>
      </div>
      
      <div class="step-item">
        <div class="step-icon" style="background-color: #ff6d01;">4</div>
        <div class="step-content">
          <div class="step-title">
            Review Timeoffs
            <span id="timeoff-badge" class="step-badge hidden">0 pending</span>
          </div>
          <div class="step-description">Approve or reject volunteer timeoff requests</div>
          <button id="btn-timeoffs" class="btn btn-primary" disabled>
            Review Timeoffs
          </button>
        </div>
      </div>
      
      <div class="step-item">
        <div class="step-icon" style="background-color: #1e8e3e;">5</div>
        <div class="step-content">
          <div class="step-title">Auto-Assign Volunteers</div>
          <div class="step-description">Automatically assign qualified volunteers to ministry roles</div>
          <button id="btn-step2" class="btn btn-secondary" disabled>
            Auto-Assign Volunteers
          </button>
        </div>
      </div>
      
    </div>
  </div>

  <div class="phase-container">
    <div class="phase-header completion">
      <span>üìÑ</span>
      <span>Finalize & Export</span>
    </div>
    <div class="phase-content disabled" id="phase-completion-content">
      
      <div class="step-item">
        <div class="step-icon" style="background-color: #9334e6;">6</div>
        <div class="step-content">
          <div class="step-title">Print Schedule</div>
          <div class="step-description">Export completed assignments for distribution</div>
          <button id="btn-print" class="btn btn-outline" disabled>
            Print Schedule
          </button>
        </div>
      </div>
      
    </div>
  </div>

  <div id="status-message" class="status-message" role="status" aria-live="polite"></div>

  <script>
    // Enhanced JavaScript with grouped workflow state management
    
    const monthSelect = document.getElementById('month-select');
    const btnAdmin = document.getElementById('btn-admin');
    const btnStep1 = document.getElementById('btn-step1');
    const btnTimeoffs = document.getElementById('btn-timeoffs');
    const btnStep2 = document.getElementById('btn-step2');
    const btnPrint = document.getElementById('btn-print');
    const statusMessage = document.getElementById('status-message');
    
    // Phase elements
    const phaseSetup = document.getElementById('phase-setup');
    const phaseScheduling = document.getElementById('phase-scheduling');
    const phaseCompletion = document.getElementById('phase-completion');
    
    // Phase content elements
    const phaseSetupContent = document.getElementById('phase-setup-content');
    const phaseSchedulingContent = document.getElementById('phase-scheduling-content');
    const phaseCompletionContent = document.getElementById('phase-completion-content');
    
    // Badge elements
    const timeoffBadge = document.getElementById('timeoff-badge');

    let allButtons;
    let currentPhase = 'setup';
    let pendingTimeoffs = 0;
    
    // Update phase progress indicator
    function updatePhaseProgress(phase) {
      // Reset all phases
      [phaseSetup, phaseScheduling, phaseCompletion].forEach(p => {
        p.className = 'phase-step';
      });
      
      // Mark completed and active phases
      switch(phase) {
        case 'setup':
          phaseSetup.className = 'phase-step active';
          break;
        case 'scheduling':
          phaseSetup.className = 'phase-step completed';
          phaseScheduling.className = 'phase-step active';
          break;
        case 'completion':
          phaseSetup.className = 'phase-step completed';
          phaseScheduling.className = 'phase-step completed';
          phaseCompletion.className = 'phase-step active';
          break;
      }
      
      currentPhase = phase;
    }
    
    // Update phase content states
    function updatePhaseStates() {
      const hasCalendar = monthSelect.options.length > 1;
      const hasMonthSelected = monthSelect.value !== '';
      
      // Enable/disable phase content based on dependencies
      if (hasCalendar) {
        phaseSchedulingContent.classList.remove('disabled');
        updatePhaseProgress('scheduling');
        
        if (hasMonthSelected) {
          // Keep scheduling enabled, enable completion when assignments are done
          // This will be updated by individual button states
        }
      } else {
        phaseSchedulingContent.classList.add('disabled');
        phaseCompletionContent.classList.add('disabled');
        updatePhaseProgress('setup');
      }
    }
    
    // Enhanced button state management
    function updateButtonStates() {
      const hasCalendar = monthSelect.options.length > 1;
      const hasMonthSelected = monthSelect.value !== '';
      
      // Month selection
      monthSelect.disabled = !hasCalendar;
      
      // Scheduling phase buttons
      btnStep1.disabled = !hasCalendar || !hasMonthSelected;
      btnTimeoffs.disabled = !hasCalendar || !hasMonthSelected;
      btnStep2.disabled = !hasCalendar || !hasMonthSelected;

      // Completion phase buttons (enable after assignment)
      btnPrint.disabled = !hasCalendar || !hasMonthSelected;

      updatePhaseStates();
      updateBadges();
    }
    
    // Update notification badges
    function updateBadges() {
      // Timeoff badge
      if (pendingTimeoffs > 0) {
        timeoffBadge.textContent = `${pendingTimeoffs} pending`;
        timeoffBadge.classList.remove('hidden');
      } else {
        timeoffBadge.classList.add('hidden');
      }
    }
    
    // Fetch additional data for badges
    function refreshWorkflowData() {
      if (monthSelect.value) {
        // Get pending timeoffs count
        google.script.run
          .withSuccessHandler((count) => {
            pendingTimeoffs = count || 0;
            updateBadges();
          })
          .withFailureHandler(() => {
            pendingTimeoffs = 0;
            updateBadges();
          })
          .getPendingTimeoffsCount();
      }
    }
    
    // Initialization
    window.addEventListener('load', () => {
      allButtons = [btnAdmin, btnStep1, btnTimeoffs, btnStep2, btnPrint];
      updatePhaseProgress('setup');
      
      google.script.run
        .withSuccessHandler(onMonthsLoaded)
        .withFailureHandler(showError)
        .getMonthsForSidebar();
    });
    
    // Month selection handler
    monthSelect.addEventListener('change', () => {
      updateButtonStates();
      refreshWorkflowData();
    });
    
    function onMonthsLoaded(months) {
      if (months.length === 0) {
        monthSelect.innerHTML = '<option value="">No calendar data found</option>';
        showError("Please run 'Generate Liturgical Calendar' first.");
        updatePhaseProgress('setup');
        return;
      }
      
      monthSelect.innerHTML = '<option value="">Select a month...</option>';
      months.forEach(monthObj => {
        const option = document.createElement('option');
        option.value = monthObj.value;
        option.textContent = monthObj.display;
        monthSelect.appendChild(option);
      });
      
      updateButtonStates();
    }
    
    // Button click handlers with enhanced workflow management
    btnAdmin.addEventListener('click', () => {
      if (!confirm('This will regenerate the entire liturgical calendar. Any manual adjustments will be lost. Continue?')) {
        return;
      }
      
      const msg = "Generating liturgical calendar...";
      showLoading(msg);
      
      google.script.run
        .withSuccessHandler((message) => {
          showSuccess(message);
          updatePhaseProgress('scheduling');
        })
        .withFailureHandler(showError)
        .triggerCalendarGeneration();
    });
    
    // *** MODIFIED btnStep1 listener ***
    btnStep1.addEventListener('click', () => {
      const selectedMonth = monthSelect.value;
      if (!selectedMonth) return;
      
      const selectedText = monthSelect.options[monthSelect.selectedIndex].text;
      
      // --- NEW: Add confirmation logic ---
      const message = "Are you sure you want to generate the schedule for " + selectedText + "?\n\n" +
                      "This will delete ALL existing assignments for this month (both 'Assigned' and 'Unassigned') and start over.\n\n" +
                      "This action cannot be undone.";
      
      if (confirm(message)) {
        // User clicked "OK", proceed with generation.
        const msg = `Generating ministry roles for ${selectedText}...`;
        showLoading(msg); // Show loading *after* confirm
        
        google.script.run
          .withSuccessHandler((message) => {
            const friendlyMessage = message.replace(selectedMonth, selectedText);
            showSuccess(friendlyMessage);
            refreshWorkflowData();
          })
          .withFailureHandler(showError)
          .triggerScheduleGeneration(selectedMonth);
          
      } else {
        // User clicked "Cancel", do nothing.
        return;
      }
      // --- END: New logic ---
    });
    
    btnTimeoffs.addEventListener('click', () => {
      const selectedMonth = monthSelect.value;
      if (!selectedMonth) return;
      
      const msg = "Loading timeoff requests...";
      showLoading(msg);
      
      google.script.run
        .withSuccessHandler((message) => {
          showSuccess(message);
          refreshWorkflowData();
        })
        .withFailureHandler(showError)
        .reviewTimeoffs(selectedMonth);
    });
    
    btnStep2.addEventListener('click', () => {
      const selectedMonth = monthSelect.value;
      if (!selectedMonth) return;

      const selectedText = monthSelect.options[monthSelect.selectedIndex].text;
      const msg = `Auto-assigning volunteers for ${selectedText}...`;
      showLoading(msg);
      
      google.script.run
        .withSuccessHandler((message) => {
          const friendlyMessage = message.replace(selectedMonth, selectedText);
          showSuccess(friendlyMessage);
          refreshWorkflowData();
        })
        .withFailureHandler(showError)
        .triggerAssignment(selectedMonth);
    });
    
    btnPrint.addEventListener('click', () => {
      const selectedMonth = monthSelect.value;
      if (!selectedMonth) return;
      
      const selectedText = monthSelect.options[monthSelect.selectedIndex].text;
      const msg = `Generating printable schedule for ${selectedText}...`;
      showLoading(msg);
      
      google.script.run
        .withSuccessHandler((message) => {
          const friendlyMessage = message.replace(selectedMonth, selectedText);
          showSuccess(friendlyMessage);
        })
        .withFailureHandler(showError)
        .generatePrintableSchedule(selectedMonth);
    });

    // Enhanced status functions
    function showLoading(message) {
      statusMessage.className = 'status-message status-loading';
      statusMessage.innerHTML = '<div class="spinner"></div><span>' + message + '</span>';
      statusMessage.setAttribute('aria-busy', 'true');
      allButtons.forEach(btn => btn.disabled = true);
    }
    
    function showSuccess(message) {
      statusMessage.className = 'status-message status-success';
      statusMessage.innerHTML = '<span>‚úì</span><span>' + message + '</span>';
      statusMessage.setAttribute('aria-busy', 'false');
      updateButtonStates();
      
      // Auto-hide success message after 5 seconds
      setTimeout(() => {
        // Re-check class, in case another message has appeared
        if (statusMessage.classList.contains('status-success')) {
           statusMessage.className = 'status-message hidden';
        }
      }, 5000);
      
      // If we just ran calendar generation, refresh month list
      if (message.includes("liturgical calendar")) {
        monthSelect.innerHTML = '<option value="">Reloading months...</option>';
        google.script.run
          .withSuccessHandler(onMonthsLoaded)
          .withFailureHandler(showError)
          .getMonthsForSidebar();
      }
    }
    
    function showError(error) {
      statusMessage.className = 'status-message status-error';
      statusMessage.innerHTML = '<span>‚ö†</span><span>Error: ' + (error.message || error) + '</span>';
      statusMessage.setAttribute('aria-busy', 'false');
      updateButtonStates();
    }
    
  </script>
</body>
</html>
