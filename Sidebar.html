<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  
  <style>
    body {
      font-family: 'Roboto', 'Arial', sans-serif;
      padding: 16px;
      margin: 0;
      background-color: #f8f9fa;
      color: #3c4043;
      line-height: 1.5;
    }
    
    /* Header */
    .header {
      text-align: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .header h3 {
      font-weight: 500;
      font-size: 20px;
      margin: 0;
      color: #1f1f1f;
    }
    
    .header .subtitle {
      font-size: 12px;
      color: #5f6368;
      margin-top: 4px;
    }
    
    /* Phase Progress Indicator */
    .phase-progress {
      display: flex;
      justify-content: space-between;
      margin-bottom: 24px;
      padding: 16px;
      background: white;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }
    
    .phase-step {
      flex: 1;
      text-align: center;
      font-size: 12px;
      color: #5f6368;
      position: relative;
    }
    
    .phase-step.completed {
      color: #137333;
      font-weight: 500;
    }
    
    .phase-step.active {
      color: #1967d2;
      font-weight: 500;
    }
    
    .phase-step::after {
      content: '';
      position: absolute;
      top: -6px;
      left: 50%;
      transform: translateX(-50%);
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #e0e0e0;
    }
    
    .phase-step.completed::after {
      background: #137333;
    }
    
    .phase-step.active::after {
      background: #1967d2;
    }
    
    /* Phase Sections */
    .phase-container {
      margin-bottom: 24px;
    }
    
    .phase-header {
      background: linear-gradient(135deg, #1a73e8, #1557b0);
      color: white;
      padding: 12px 16px;
      border-radius: 8px 8px 0 0;
      font-weight: 500;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .phase-header.setup {
      background: linear-gradient(135deg, #f9ab00, #e8a317);
      color: #1f1f1f;
    }
    
    .phase-header.completion {
      background: linear-gradient(135deg, #1e8e3e, #188038);
    }
    
    .phase-content {
      background: white;
      border: 1px solid #e0e0e0;
      border-top: none;
      border-radius: 0 0 8px 8px;
      padding: 0;
    }
    
    .phase-content.disabled {
      opacity: 0.6;
      pointer-events: none;
    }
    
    /* Step Items */
    .step-item {
      padding: 16px;
      border-bottom: 1px solid #f1f3f4;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .step-item:last-child {
      border-bottom: none;
    }
    
    .step-item.disabled {
      opacity: 0.5;
      pointer-events: none;
    }
    
    .step-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
      color: white;
      flex-shrink: 0;
    }
    
    .step-content {
      flex: 1;
      min-width: 0;
    }
    
    .step-title {
      font-weight: 500;
      font-size: 14px;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .step-description {
      font-size: 12px;
      color: #5f6368;
      line-height: 1.4;
    }
    
    .step-badge {
      background: #ea4335;
      color: white;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 10px;
      font-weight: 500;
    }
    
    .step-badge.info {
      background: #1a73e8;
    }

    .completion-badge {
      background: #137333;
      color: white;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 10px;
      font-weight: 500;
      margin-left: 8px;
    }

    /* Buttons */
    .btn {
      width: 100%;
      padding: 10px 14px;
      font-size: 13px;
      font-weight: 500;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      margin-top: 8px;
    }
    
    .btn:disabled {
      background-color: #f1f3f4;
      color: #9aa0a6;
      cursor: not-allowed;
    }
    
    .btn-primary {
      background-color: #1a73e8;
      color: white;
    }
    
    .btn-primary:hover:not(:disabled) {
      background-color: #1557b0;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(26, 115, 232, 0.25);
    }
    
    .btn-secondary {
      background-color: #1e8e3e;
      color: white;
    }
    
    .btn-secondary:hover:not(:disabled) {
      background-color: #188038;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(30, 142, 62, 0.25);
    }
    
    .btn-warning {
      background-color: #f9ab00;
      color: #1f1f1f;
    }
    
    .btn-warning:hover:not(:disabled) {
      background-color: #e8a317;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(249, 171, 0, 0.25);
    }
    
    .btn-outline {
      background-color: white;
      color: #1a73e8;
      border: 1px solid #dadce0;
    }
    
    .btn-outline:hover:not(:disabled) {
      background-color: #f8f9fa;
      border-color: #1a73e8;
    }
    
    /* Form Elements */
    .form-group {
      margin-bottom: 12px;
    }
    
    .form-label {
      font-size: 12px;
      font-weight: 500;
      color: #3c4043;
      margin-bottom: 4px;
      display: block;
    }
    
    .form-select {
      width: 100%;
      padding: 8px 10px;
      font-size: 13px;
      border: 1px solid #dadce0;
      border-radius: 6px;
      background-color: white;
      color: #3c4043;
      box-sizing: border-box;
    }
    
    .form-select:focus {
      outline: none;
      border-color: #1a73e8;
      box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
    }
    
    .form-select:disabled {
      background-color: #f1f3f4;
      color: #9aa0a6;
    }
    
    /* Status Messages */
    .status-message {
      margin-top: 20px;
      padding: 12px 16px;
      border-radius: 6px;
      font-size: 13px;
      display: none;
      align-items: center;
      gap: 8px;
    }
    
    .status-loading {
      display: flex;
      background-color: #e8f0fe;
      color: #1967d2;
      border: 1px solid #d2e3fc;
    }
    
    .status-success {
      display: flex;
      background-color: #e6f4ea;
      color: #137333;
      border: 1px solid #c6e6d4;
    }
    
    .status-error {
      display: flex;
      background-color: #fce8e6;
      color: #c5221f;
      border: 1px solid #f9c6c2;
    }
    
    /* Loading Spinner */
    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid transparent;
      border-top: 2px solid currentColor;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Hidden elements */
    .hidden {
      display: none !important;
    }
    
    /* Accessibility */
    .btn:focus {
      outline: 2px solid #1a73e8;
      outline-offset: 2px;
    }
  </style>
</head>

<body>
  <div class="header">
    <h3>Parish Scheduler</h3>
    <div class="subtitle">Liturgical Ministry Management</div>
  </div>

  <div class="phase-progress">
    <div class="phase-step" id="phase-setup">Setup</div>
    <div class="phase-step" id="phase-scheduling">Scheduling</div>
    <div class="phase-step" id="phase-completion">Completion</div>
  </div>

  <div class="phase-container">
    <div class="phase-header setup">
      <span>‚öôÔ∏è</span>
      <span>Initial Setup</span>
    </div>
    <div class="phase-content" id="phase-setup-content">

      <div class="step-item">
        <div class="step-icon" style="background-color: #f9ab00;">1</div>
        <div class="step-content">
          <div class="step-title">
            Generate Liturgical Calendar
            <span id="completion-calendar" class="completion-badge hidden">‚úì Complete</span>
          </div>
          <div class="step-description">Run once per year to create the complete liturgical calendar</div>
          <button id="btn-admin" class="btn btn-warning" aria-label="Generate liturgical calendar for the entire year">
            Generate Calendar
          </button>
        </div>
      </div>

      <div class="step-item">
        <div class="step-icon" style="background-color: #f9ab00;">2</div>
        <div class="step-content">
          <div class="step-title">
            Validate Data
            <span id="completion-validation" class="completion-badge hidden">‚úì Complete</span>
          </div>
          <div class="step-description">Check configuration, volunteers, and mass templates for errors</div>
          <button id="btn-validate" class="btn btn-warning" aria-label="Validate all data before scheduling">
            Validate Data
          </button>
        </div>
      </div>

    </div>
  </div>

  <div class="phase-container">
    <div class="phase-header">
      <span>üìÖ</span>
      <span>Monthly Scheduling</span>
    </div>
    <div class="phase-content disabled" id="phase-scheduling-content">

      <div class="step-item">
        <div class="step-icon" style="background-color: #1a73e8;">3</div>
        <div class="step-content">
          <div class="step-title">Select Month</div>
          <div class="step-description">Choose which month to schedule</div>
          <div class="form-group">
            <label for="month-select" class="form-label">Month to Schedule</label>
            <select id="month-select" class="form-select" disabled>
              <option value="">Loading months...</option>
            </select>
          </div>
        </div>
      </div>

      <div class="step-item">
        <div class="step-icon" style="background-color: #1a73e8;">4</div>
        <div class="step-content">
          <div class="step-title">
            Generate Schedule
            <span id="completion-schedule" class="completion-badge hidden">‚úì Complete</span>
          </div>
          <div class="step-description">Create unassigned ministry roles for all masses</div>
          <button id="btn-step1" class="btn btn-primary" disabled>
            Generate Schedule
          </button>
        </div>
      </div>

      <div class="step-item">
        <div class="step-icon" style="background-color: #1a73e8;">5</div>
        <div class="step-content">
          <div class="step-title">
            Update Timeoff Form
            <span id="completion-form-update" class="completion-badge hidden">‚úì Complete</span>
          </div>
          <div class="step-description">Update form with current month's dates and volunteer list</div>
          <button id="btn-update-form" class="btn btn-primary" disabled>
            Update Timeoff Form
          </button>
        </div>
      </div>

      <div class="step-item">
        <div class="step-icon" style="background-color: #1a73e8;">6</div>
        <div class="step-content">
          <div class="step-title">
            Review Timeoffs
            <span id="timeoff-badge" class="step-badge hidden">0 pending</span>
            <span id="completion-timeoffs" class="completion-badge hidden">‚úì Complete</span>
          </div>
          <div class="step-description">Approve or reject volunteer timeoff requests</div>
          <button id="btn-timeoffs" class="btn btn-primary" disabled>
            Review Timeoffs
          </button>
        </div>
      </div>

      <div class="step-item">
        <div class="step-icon" style="background-color: #1a73e8;">7</div>
        <div class="step-content">
          <div class="step-title">
            Auto-Assign Volunteers
            <span id="completion-assignment" class="completion-badge hidden">‚úì Complete</span>
          </div>
          <div class="step-description">Automatically assign qualified volunteers to ministry roles</div>
          <button id="btn-step2" class="btn btn-primary" disabled>
            Auto-Assign Volunteers
          </button>
        </div>
      </div>

    </div>
  </div>

  <!-- Finalize & Export Section -->
  <div class="phase-container">
    <div class="phase-header completion">
      <span>üìÑ</span>
      <span>Finalize & Export</span>
    </div>
    <div class="phase-content disabled" id="phase-completion-content">

      <!-- STEP 9: Custom Print -->
      <div class="step-item">
        <div class="step-icon" style="background-color: #1e8e3e;">9</div>
        <div class="step-content">
          <div class="step-title">
            Custom Print
            <span id="completion-custom-print" class="completion-badge hidden">‚úì Complete</span>
          </div>
          <div class="step-description">Generate one-off print schedule for any month/ministry</div>

          <!-- Month Selector -->
          <div style="margin-bottom: 10px;">
            <label for="custom-print-month" style="display: block; margin-bottom: 5px; font-size: 12px; color: #666;">
              Month to Print:
            </label>
            <select id="custom-print-month" class="month-select" style="width: 100%; padding: 8px;">
              <option value="">Select month...</option>
              <!-- Populated dynamically -->
            </select>
          </div>

          <!-- Ministry Filter -->
          <div style="margin-bottom: 10px;">
            <label for="custom-print-ministry" style="display: block; margin-bottom: 5px; font-size: 12px; color: #666;">
              Filter by Ministry (optional):
            </label>
            <select id="custom-print-ministry" class="month-select" style="width: 100%; padding: 8px;">
              <option value="All Ministries">All Ministries</option>
              <!-- Populated dynamically -->
            </select>
          </div>

          <!-- Output Sheet Name -->
          <div style="margin-bottom: 10px;">
            <label for="custom-print-sheet-name" style="display: block; margin-bottom: 5px; font-size: 12px; color: #666;">
              Output Sheet Name:
            </label>
            <input type="text" id="custom-print-sheet-name"
                   style="width: 100%; padding: 8px; border: 1px solid #dadce0; border-radius: 4px; font-size: 13px;"
                   placeholder="e.g., Lector February 2026">
          </div>

          <button id="btn-custom-print" class="btn btn-outline" disabled>
            üìÑ Generate Custom Print
          </button>

          <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #f1f3f4; font-size: 11px; color: #5f6368;">
            üí° Use this for ad-hoc reports, printing specific ministries, or archiving past months
          </div>
        </div>
      </div>

      <!-- STEP 11: Weekly Email View -->
      <div class="step-item">
        <div class="step-icon" style="background-color: #1e8e3e;">11</div>
        <div class="step-content">
          <div class="step-title">
            Weekly Email View
            <span id="completion-weekly" class="completion-badge hidden">‚úì Complete</span>
          </div>
          <div class="step-description">Generate upcoming week schedule for Monday emails</div>

          <!-- Quick Copy for Email -->
          <button id="btn-copy-email" class="btn btn-primary" disabled style="margin-bottom: 8px;">
            üìã Copy Schedule for Email
          </button>

          <!-- Email Text Preview (hidden until generated) -->
          <div id="email-preview-container" style="display: none; margin-top: 12px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
              <span id="email-preview-week" style="font-size: 12px; font-weight: bold; color: #1a73e8;"></span>
              <button id="btn-copy-again" class="btn btn-outline" style="padding: 4px 8px; font-size: 11px;">
                üìã Copy Again
              </button>
            </div>
            <textarea id="email-preview-text" readonly style="width: 100%; height: 200px; font-family: monospace; font-size: 11px; padding: 8px; border: 1px solid #dadce0; border-radius: 4px; resize: vertical; background: #f8f9fa;"></textarea>
            <div id="copy-success" style="display: none; margin-top: 6px; padding: 6px 10px; background: #e6f4ea; color: #137333; border-radius: 4px; font-size: 11px; text-align: center;">
              ‚úì Copied to clipboard! Paste into your email.
            </div>
          </div>

          <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #f1f3f4;">
            <button id="btn-weekly" class="btn btn-outline" disabled style="font-size: 12px;">
              üìÖ Refresh WeeklyView Sheet
            </button>
          </div>

          <div style="margin-top: 8px; font-size: 11px; color: #5f6368;">
            üí° <strong>Smart Logic:</strong> Mon-Wed shows current week, Thu-Sun shows next week
          </div>
        </div>
      </div>

      <!-- STEP 12: Dashboard Analytics -->
      <div class="step-item">
        <div class="step-icon" style="background-color: #7c4dff;">12</div>
        <div class="step-content">
          <div class="step-title">
            Dashboard Analytics
            <span id="completion-dashboard" class="completion-badge hidden">‚úì Complete</span>
          </div>
          <div class="step-description">Analyze volunteer participation and coverage patterns</div>

          <button id="btn-dashboard" class="btn btn-outline" disabled>
            üìä View Dashboard
          </button>
        </div>
      </div>

      <!-- STEP 13: Publish Schedule -->
      <div class="step-item">
        <div class="step-icon" style="background-color: #1e8e3e;">13</div>
        <div class="step-content">
          <div class="step-title">
            Publish Schedule
            <span id="completion-publish" class="completion-badge hidden">‚úì Complete</span>
          </div>
          <div class="step-description">Sync schedules to public volunteer spreadsheets</div>

          <!-- Publish All Ministries Button -->
          <button id="btn-publish-all" class="btn btn-secondary" disabled style="margin-bottom: 12px;">
            üìÑ Publish All Ministries
          </button>

          <!-- Individual Ministry Publishing -->
          <div style="margin-bottom: 10px;">
            <label for="publish-ministry-filter" style="display: block; margin-bottom: 5px; font-size: 12px; color: #666;">
              Or publish individual ministry:
            </label>
            <select id="publish-ministry-filter" class="month-select" style="width: 100%; padding: 8px; margin-bottom: 8px;">
              <option value="">Select ministry...</option>
              <!-- Populated dynamically -->
            </select>
            <button id="btn-publish-ministry" class="btn btn-outline" disabled>
              Publish Selected Ministry
            </button>
          </div>

          <!-- Auto-Publish Toggle -->
          <div style="margin-top: 16px; padding-top: 12px; border-top: 1px solid #f1f3f4;">
            <label style="display: flex; align-items: center; gap: 8px; font-size: 12px; color: #666; cursor: pointer;">
              <input type="checkbox" id="auto-publish-toggle" style="cursor: pointer;">
              <span>Auto-publish main schedule (every 30 min)</span>
            </label>
            <div id="auto-publish-status" style="margin-top: 4px; font-size: 11px; color: #5f6368;"></div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Archive Section -->
  <div class="phase-container">
    <div class="phase-header" style="background: linear-gradient(135deg, #5f6368, #3c4043);">
      <span>üì¶</span>
      <span>Archive Management</span>
    </div>
    <div class="phase-content">

      <div class="step-item">
        <div class="step-icon" style="background-color: #5f6368;">üóÑÔ∏è</div>
        <div class="step-content">
          <div class="step-title">Year-End Archive</div>
          <div class="step-description">Create archive file for completed year</div>
          <button id="btn-archive" class="btn btn-outline">
            Archive Current Year
          </button>
        </div>
      </div>

      <div class="step-item">
        <div class="step-icon" style="background-color: #5f6368;">üìÇ</div>
        <div class="step-content">
          <div class="step-title">View Archives</div>
          <div class="step-description">Access previous years' archived data</div>
          <button id="btn-view-archives" class="btn btn-outline">
            View Archives
          </button>
        </div>
      </div>

      <div class="step-item">
        <div class="step-icon" style="background-color: #c5221f;">üóëÔ∏è</div>
        <div class="step-content">
          <div class="step-title">Clear Old Data</div>
          <div class="step-description">Remove old data to start new year fresh</div>
          <button id="btn-clear-data" class="btn btn-outline">
            Clear Old Data
          </button>
        </div>
      </div>

    </div>
  </div>

  <div id="status-message" class="status-message" role="status" aria-live="polite"></div>

  <script>
    // Enhanced JavaScript with grouped workflow state management
    
    const monthSelect = document.getElementById('month-select');
    const btnAdmin = document.getElementById('btn-admin');
    const btnValidate = document.getElementById('btn-validate');
    const btnStep1 = document.getElementById('btn-step1');
    const btnUpdateForm = document.getElementById('btn-update-form');
    const btnTimeoffs = document.getElementById('btn-timeoffs');
    const btnStep2 = document.getElementById('btn-step2');

    // Custom Print (Step 9)
    const customPrintMonth = document.getElementById('custom-print-month');
    const customPrintMinistry = document.getElementById('custom-print-ministry');
    const customPrintSheetName = document.getElementById('custom-print-sheet-name');
    const btnCustomPrint = document.getElementById('btn-custom-print');

    // Weekly View (Step 11)
    const btnWeekly = document.getElementById('btn-weekly');
    const btnCopyEmail = document.getElementById('btn-copy-email');
    const btnCopyAgain = document.getElementById('btn-copy-again');
    const emailPreviewContainer = document.getElementById('email-preview-container');
    const emailPreviewWeek = document.getElementById('email-preview-week');
    const emailPreviewText = document.getElementById('email-preview-text');
    const copySuccess = document.getElementById('copy-success');

    // Dashboard (Step 12)
    const btnDashboard = document.getElementById('btn-dashboard');

    // Publish (Step 13)
    const btnPublishAll = document.getElementById('btn-publish-all');
    const btnPublishMinistry = document.getElementById('btn-publish-ministry');
    const publishMinistryFilter = document.getElementById('publish-ministry-filter');
    const autoPublishToggle = document.getElementById('auto-publish-toggle');
    const autoPublishStatus = document.getElementById('auto-publish-status');

    const statusMessage = document.getElementById('status-message');
    
    // Phase elements
    const phaseSetup = document.getElementById('phase-setup');
    const phaseScheduling = document.getElementById('phase-scheduling');
    const phaseCompletion = document.getElementById('phase-completion');
    
    // Phase content elements
    const phaseSetupContent = document.getElementById('phase-setup-content');
    const phaseSchedulingContent = document.getElementById('phase-scheduling-content');
    const phaseCompletionContent = document.getElementById('phase-completion-content');
    
    // Badge elements
    const timeoffBadge = document.getElementById('timeoff-badge');

    // Completion badge elements
    const completionCalendar = document.getElementById('completion-calendar');
    const completionValidation = document.getElementById('completion-validation');
    const completionSchedule = document.getElementById('completion-schedule');
    const completionFormUpdate = document.getElementById('completion-form-update');
    const completionTimeoffs = document.getElementById('completion-timeoffs');
    const completionAssignment = document.getElementById('completion-assignment');
    const completionPrint = document.getElementById('completion-print');
    const completionPublish = document.getElementById('completion-publish');

    let allButtons;
    let currentPhase = 'setup';
    let pendingTimeoffs = 0;

    // Function to mark a step as complete
    function markStepComplete(stepId) {
      const badge = document.getElementById('completion-' + stepId);
      if (badge) {
        badge.classList.remove('hidden');
      }
    }

    // Update phase progress indicator
    function updatePhaseProgress(phase) {
      // Reset all phases
      [phaseSetup, phaseScheduling, phaseCompletion].forEach(p => {
        p.className = 'phase-step';
      });
      
      // Mark completed and active phases
      switch(phase) {
        case 'setup':
          phaseSetup.className = 'phase-step active';
          break;
        case 'scheduling':
          phaseSetup.className = 'phase-step completed';
          phaseScheduling.className = 'phase-step active';
          break;
        case 'completion':
          phaseSetup.className = 'phase-step completed';
          phaseScheduling.className = 'phase-step completed';
          phaseCompletion.className = 'phase-step active';
          break;
      }
      
      currentPhase = phase;
    }
    
    // Update phase content states
    function updatePhaseStates() {
      const hasCalendar = monthSelect.options.length > 1;
      const hasMonthSelected = monthSelect.value !== '';

      // Enable/disable phase content based on dependencies
      if (hasCalendar) {
        phaseSchedulingContent.classList.remove('disabled');
        phaseCompletionContent.classList.remove('disabled');
        updatePhaseProgress('scheduling');
      } else {
        phaseSchedulingContent.classList.add('disabled');
        phaseCompletionContent.classList.add('disabled');
        updatePhaseProgress('setup');
      }
    }
    
    // Enhanced button state management
    function updateButtonStates() {
      const hasCalendar = monthSelect.options.length > 1;
      const hasMonthSelected = monthSelect.value !== '';

      console.log('updateButtonStates called:', { hasCalendar, hasMonthSelected });

      // Month selection
      monthSelect.disabled = !hasCalendar;

      // Scheduling phase buttons
      btnStep1.disabled = !hasCalendar || !hasMonthSelected;
      btnUpdateForm.disabled = !hasCalendar || !hasMonthSelected;
      btnTimeoffs.disabled = !hasCalendar || !hasMonthSelected;
      btnStep2.disabled = !hasCalendar || !hasMonthSelected;

      // Step 9: Custom Print (requires month selection + sheet name)
      customPrintMonth.disabled = !hasCalendar;
      customPrintMinistry.disabled = !hasCalendar;
      customPrintSheetName.disabled = !hasCalendar;
      const hasCustomPrintMonth = customPrintMonth.value !== '';
      const hasCustomPrintSheetName = customPrintSheetName.value.trim() !== '';
      btnCustomPrint.disabled = !hasCalendar || !hasCustomPrintMonth || !hasCustomPrintSheetName;

      // Step 11: Weekly Email View (always enabled after calendar exists)
      btnWeekly.disabled = !hasCalendar;
      btnCopyEmail.disabled = !hasCalendar;

      // Step 12: Dashboard Analytics (requires month selection)
      btnDashboard.disabled = !hasCalendar || !hasMonthSelected;

      // Step 13: Publish buttons (require month selection)
      publishMinistryFilter.disabled = !hasCalendar || !hasMonthSelected;
      btnPublishAll.disabled = !hasCalendar || !hasMonthSelected;
      const hasMinistrySelected = publishMinistryFilter.value !== '';
      btnPublishMinistry.disabled = !hasCalendar || !hasMonthSelected || !hasMinistrySelected;

      updatePhaseStates();
      updateBadges();
    }
    
    // Update notification badges
    function updateBadges() {
      // Timeoff badge
      if (pendingTimeoffs > 0) {
        timeoffBadge.textContent = `${pendingTimeoffs} pending`;
        timeoffBadge.classList.remove('hidden');
      } else {
        timeoffBadge.classList.add('hidden');
      }
    }
    
    // Fetch additional data for badges
    function refreshWorkflowData() {
      if (monthSelect.value) {
        // Get pending timeoffs count
        google.script.run
          .withSuccessHandler((count) => {
            pendingTimeoffs = count || 0;
            updateBadges();
          })
          .withFailureHandler(() => {
            pendingTimeoffs = 0;
            updateBadges();
          })
          .getPendingTimeoffsCount();
      }
    }
    
    // Initialization
    window.addEventListener('load', () => {
      allButtons = [btnAdmin, btnValidate, btnStep1, btnUpdateForm, btnTimeoffs, btnStep2, btnCustomPrint, btnWeekly, btnDashboard, btnPublishAll, btnPublishMinistry];
      updatePhaseProgress('setup');

      google.script.run
        .withSuccessHandler(onMonthsLoaded)
        .withFailureHandler((error) => showError(error, 'calendar'))
        .getMonthsForSidebar();

      // Load ministries for filter dropdowns (print and publish)
      google.script.run
        .withSuccessHandler(onMinistriesLoaded)
        .withFailureHandler((error) => console.error('Failed to load ministries:', error))
        .getActiveMinistries();

      // Load auto-publish status
      google.script.run
        .withSuccessHandler(onAutoPublishStatusLoaded)
        .withFailureHandler((error) => console.error('Failed to load auto-publish status:', error))
        .AUTOPUBLISH_getStatus();

      // Load next 12 months for custom print dropdown
      google.script.run
        .withSuccessHandler(onCustomPrintMonthsLoaded)
        .withFailureHandler((error) => console.error('Failed to load custom print months:', error))
        .getNext12Months();
    });
    
    // Month selection handler
    monthSelect.addEventListener('change', () => {
      updateButtonStates();
      refreshWorkflowData();
    });
    
    function onMinistriesLoaded(ministries) {
      // Populate custom print ministry filter
      customPrintMinistry.innerHTML = '<option value="All Ministries">All Ministries</option>';

      // Populate publish filter dropdown
      publishMinistryFilter.innerHTML = '<option value="">Select ministry...</option>';

      // Add ministry options to dropdowns
      ministries.forEach(ministry => {
        // Add to custom print filter
        const opt1 = document.createElement('option');
        opt1.value = ministry;
        opt1.textContent = ministry;
        customPrintMinistry.appendChild(opt1);

        // Add to publish filter dropdown
        const opt2 = document.createElement('option');
        opt2.value = ministry;
        opt2.textContent = ministry;
        publishMinistryFilter.appendChild(opt2);
      });

      console.log(`Loaded ${ministries.length} ministries for filter dropdowns`);

      // Update button states now that ministries are loaded
      updateButtonStates();
    }

    function onCustomPrintMonthsLoaded(months) {
      customPrintMonth.innerHTML = '<option value="">Select month...</option>';

      months.forEach(monthObj => {
        const option = document.createElement('option');
        option.value = monthObj.value;
        option.textContent = monthObj.display;
        customPrintMonth.appendChild(option);
      });

      console.log(`Loaded ${months.length} months for custom print dropdown`);
    }

    function onMonthsLoaded(months) {
      if (months.length === 0) {
        monthSelect.innerHTML = '<option value="">No calendar data found</option>';
        showError({message: "Please run 'Generate Liturgical Calendar' first."}, 'calendar');
        updatePhaseProgress('setup');
        return;
      }
      
      monthSelect.innerHTML = '<option value="">Select a month...</option>';
      months.forEach(monthObj => {
        const option = document.createElement('option');
        option.value = monthObj.value;
        option.textContent = monthObj.display;
        monthSelect.appendChild(option);
      });
      
      updateButtonStates();
    }
    
    // Button click handlers with enhanced workflow management
    btnAdmin.addEventListener('click', () => {
      if (!confirm('This will regenerate the entire liturgical calendar. Any manual adjustments will be lost. Continue?')) {
        return;
      }

      const msg = "Generating liturgical calendar...";
      showLoading(msg);

      google.script.run
        .withSuccessHandler((message) => {
          showSuccess(message);
          markStepComplete('calendar');
          updatePhaseProgress('scheduling');
        })
        .withFailureHandler((error) => showError(error, 'calendar'))
        .triggerCalendarGeneration();
    });

    btnValidate.addEventListener('click', () => {
      const msg = "Validating data...";
      showLoading(msg);

      google.script.run
        .withSuccessHandler((message) => {
          showSuccess(message);
          markStepComplete('validation');
        })
        .withFailureHandler((error) => showError(error, 'validation'))
        .showDataValidation();
    });

    // *** MODIFIED btnStep1 listener ***
    btnStep1.addEventListener('click', () => {
      const selectedMonth = monthSelect.value;
      if (!selectedMonth) return;
      
      const selectedText = monthSelect.options[monthSelect.selectedIndex].text;
      
      // --- NEW: Add confirmation logic ---
      const message = "Are you sure you want to generate the schedule for " + selectedText + "?\n\n" +
                      "This will delete ALL existing assignments for this month (both 'Assigned' and 'Unassigned') and start over.\n\n" +
                      "This action cannot be undone.";
      
      if (confirm(message)) {
        // User clicked "OK", proceed with generation.
        const msg = `Generating ministry roles for ${selectedText}...`;
        showLoading(msg); // Show loading *after* confirm
        
        google.script.run
          .withSuccessHandler((message) => {
            const friendlyMessage = message.replace(selectedMonth, selectedText);
            showSuccess(friendlyMessage);
            markStepComplete('schedule');
            refreshWorkflowData();
          })
          .withFailureHandler((error) => showError(error, 'schedule'))
          .triggerScheduleGeneration(selectedMonth);
          
      } else {
        // User clicked "Cancel", do nothing.
        return;
      }
      // --- END: New logic ---
    });

    btnUpdateForm.addEventListener('click', () => {
      const selectedMonth = monthSelect.value;
      if (!selectedMonth) return;

      const selectedText = monthSelect.options[monthSelect.selectedIndex].text;
      const msg = `Updating timeoff form for ${selectedText}...`;
      showLoading(msg);

      google.script.run
        .withSuccessHandler((message) => {
          showSuccess(message);
          markStepComplete('form-update');
        })
        .withFailureHandler((error) => showError(error, 'form-update'))
        .TIMEOFFS_updateFormForMonth(selectedMonth);
    });

    btnTimeoffs.addEventListener('click', () => {
      const selectedMonth = monthSelect.value;
      if (!selectedMonth) return;
      
      const msg = "Loading timeoff requests...";
      showLoading(msg);
      
      google.script.run
        .withSuccessHandler((message) => {
          showSuccess(message);
          markStepComplete('timeoffs');
          refreshWorkflowData();
        })
        .withFailureHandler((error) => showError(error, 'timeoffs'))
        .reviewTimeoffs(selectedMonth);
    });
    
    btnStep2.addEventListener('click', () => {
      const selectedMonth = monthSelect.value;
      if (!selectedMonth) return;

      const selectedText = monthSelect.options[monthSelect.selectedIndex].text;
      const msg = `Auto-assigning volunteers for ${selectedText}...`;
      showLoading(msg);
      
      google.script.run
        .withSuccessHandler((message) => {
          const friendlyMessage = message.replace(selectedMonth, selectedText);
          showSuccess(friendlyMessage);
          markStepComplete('assignment');
          refreshWorkflowData();
        })
        .withFailureHandler((error) => showError(error, 'assignment'))
        .triggerAssignment(selectedMonth);
    });
    
    // STEP 9: Custom Print button
    btnCustomPrint.addEventListener('click', () => {
      const selectedMonth = customPrintMonth.value;
      const selectedMinistry = customPrintMinistry.value;
      const sheetName = customPrintSheetName.value.trim();

      if (!selectedMonth) {
        showError({ message: 'Please select a month to print' }, 'print');
        return;
      }

      if (!sheetName) {
        showError({ message: 'Please enter an output sheet name' }, 'print');
        return;
      }

      const monthText = customPrintMonth.options[customPrintMonth.selectedIndex].text;
      const filterText = selectedMinistry && selectedMinistry !== 'All Ministries' ? ` (${selectedMinistry})` : '';
      showLoading(`Generating custom print: ${sheetName}...`);

      google.script.run
        .withSuccessHandler((result) => {
          if (result.success) {
            showSuccess(result.message);
            markStepComplete('custom-print');
            // Clear form for next use
            customPrintMonth.value = '';
            customPrintSheetName.value = '';
          } else {
            showError({ message: result.error }, 'print');
          }
        })
        .withFailureHandler((error) => showError(error, 'print'))
        .generateCustomPrint(selectedMonth, selectedMinistry, sheetName);
    });

    // STEP 11: Copy Schedule for Email button
    btnCopyEmail.addEventListener('click', () => {
      showLoading('Generating schedule for email...');

      google.script.run
        .withSuccessHandler((result) => {
          // Display the preview
          emailPreviewText.value = result.text;
          emailPreviewWeek.textContent = result.weekString;
          emailPreviewContainer.style.display = 'block';

          // Copy to clipboard
          copyScheduleToClipboard(result.text);

          // Clear loading state and re-enable buttons
          statusMessage.className = 'status-message hidden';
          updateButtonStates();
          markStepComplete('weekly');
        })
        .withFailureHandler((error) => {
          showError(error, 'print');
        })
        .getScheduleForEmailCopy({});
    });

    // Copy Again button
    btnCopyAgain.addEventListener('click', () => {
      copyScheduleToClipboard(emailPreviewText.value);
    });

    // Helper function to copy to clipboard
    function copyScheduleToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        // Show success message
        copySuccess.style.display = 'block';
        setTimeout(() => {
          copySuccess.style.display = 'none';
        }, 3000);
      }).catch(err => {
        // Fallback: select text in textarea
        emailPreviewText.select();
        emailPreviewText.setSelectionRange(0, 99999);
        try {
          document.execCommand('copy');
          copySuccess.style.display = 'block';
          setTimeout(() => {
            copySuccess.style.display = 'none';
          }, 3000);
        } catch (e) {
          showError({ message: 'Could not copy to clipboard. Please select the text manually and copy.' }, 'print');
        }
      });
    }

    // STEP 11: Refresh WeeklyView Sheet button
    btnWeekly.addEventListener('click', () => {
      showLoading('Regenerating weekly view sheet...');

      google.script.run
        .withSuccessHandler((message) => {
          showSuccess('Weekly view sheet regenerated!');
        })
        .withFailureHandler((error) => showError(error, 'print'))
        .generateWeeklyView(null, { sheetName: 'WeeklyView' });
    });

    // Auto-suggest sheet name for custom print based on selections
    // Uses abbreviated month-year format (e.g., "Feb 2026") to keep names concise
    function updateCustomPrintSheetName() {
      const month = customPrintMonth.value;
      const ministry = customPrintMinistry.value;

      if (month && customPrintSheetName.value.trim() === '') {
        // Only auto-fill if user hasn't typed anything
        // Parse YYYY-MM value to produce short "Mon YYYY" format
        const [yr, mo] = month.split('-').map(Number);
        const shortMonth = new Date(yr, mo - 1, 1).toLocaleDateString('en-US', { month: 'short' });
        const monthText = `${shortMonth} ${yr}`;
        const ministryText = ministry && ministry !== 'All Ministries' ? `${ministry} ` : '';
        customPrintSheetName.value = `${ministryText}${monthText}`;
      }
    }

    customPrintMonth.addEventListener('change', () => {
      updateCustomPrintSheetName();
      updateButtonStates();
    });

    customPrintMinistry.addEventListener('change', () => {
      updateCustomPrintSheetName();
      updateButtonStates();
    });

    customPrintSheetName.addEventListener('input', () => {
      updateButtonStates();
    });

    // Dashboard Analytics button
    btnDashboard.addEventListener('click', () => {
      const selectedMonth = monthSelect.value;
      if (!selectedMonth) return;

      const selectedText = monthSelect.options[monthSelect.selectedIndex].text;
      const msg = `Generating dashboard analytics for ${selectedText}...`;
      showLoading(msg);

      google.script.run
        .withSuccessHandler((message) => {
          showSuccess(message);
          markStepComplete('dashboard');
        })
        .withFailureHandler((error) => showError(error, 'schedule'))
        .DASHBOARD_generateSimplified(selectedMonth);
    });

    // Publish All Ministries button
    btnPublishAll.addEventListener('click', () => {
      const selectedMonth = monthSelect.value;
      if (!selectedMonth) return;

      const selectedText = monthSelect.options[monthSelect.selectedIndex].text;
      const msg = `Publishing all ministry schedules for ${selectedText}...`;
      showLoading(msg);

      google.script.run
        .withSuccessHandler((message) => {
          showSuccess(message);
          markStepComplete('publish');
        })
        .withFailureHandler((error) => showError(error, 'publish'))
        .PUBLISH_publishAllMinistries(selectedMonth);
    });

    // Publish Individual Ministry button
    btnPublishMinistry.addEventListener('click', () => {
      const selectedMonth = monthSelect.value;
      const selectedMinistry = publishMinistryFilter.value;
      if (!selectedMonth || !selectedMinistry) return;

      const selectedText = monthSelect.options[monthSelect.selectedIndex].text;
      const msg = `Publishing ${selectedMinistry} schedule for ${selectedText}...`;
      showLoading(msg);

      google.script.run
        .withSuccessHandler((message) => {
          showSuccess(message);
          markStepComplete('publish');
        })
        .withFailureHandler((error) => showError(error, 'publish'))
        .PUBLISH_syncMonthlyViewToPublic(selectedMonth, { ministryFilter: [selectedMinistry] });
    });

    // Publish ministry filter change handler
    publishMinistryFilter.addEventListener('change', () => {
      updateButtonStates();
    });

    // Auto-publish toggle handler
    autoPublishToggle.addEventListener('change', () => {
      const isEnabled = autoPublishToggle.checked;

      if (isEnabled) {
        // Enable auto-publish
        showLoading('Enabling auto-publish...');
        google.script.run
          .withSuccessHandler((message) => {
            showSuccess(message);
            loadAutoPublishStatus();
          })
          .withFailureHandler((error) => {
            showError(error, 'publish');
            autoPublishToggle.checked = false;
            loadAutoPublishStatus();
          })
          .AUTOPUBLISH_setupTrigger(30); // 30 minute interval
      } else {
        // Disable auto-publish
        showLoading('Disabling auto-publish...');
        google.script.run
          .withSuccessHandler((message) => {
            showSuccess(message);
            loadAutoPublishStatus();
          })
          .withFailureHandler((error) => {
            showError(error, 'publish');
            autoPublishToggle.checked = true;
            loadAutoPublishStatus();
          })
          .AUTOPUBLISH_removeTrigger();
      }
    });

    // Load auto-publish status helper
    function loadAutoPublishStatus() {
      google.script.run
        .withSuccessHandler(onAutoPublishStatusLoaded)
        .withFailureHandler((error) => console.error('Failed to load auto-publish status:', error))
        .AUTOPUBLISH_getStatus();
    }

    function onAutoPublishStatusLoaded(status) {
      autoPublishToggle.checked = status.enabled;

      if (status.enabled && status.triggerExists) {
        autoPublishStatus.textContent = `‚úì Active - Publishing every ${status.interval} minutes`;
        autoPublishStatus.style.color = '#137333';
      } else if (status.enabled && !status.triggerExists) {
        autoPublishStatus.textContent = '‚ö† Enabled in config but no trigger found';
        autoPublishStatus.style.color = '#f9ab00';
      } else {
        autoPublishStatus.textContent = 'Disabled';
        autoPublishStatus.style.color = '#5f6368';
      }
    }

    // Archive button event listeners
    const btnArchive = document.getElementById('btn-archive');
    const btnViewArchives = document.getElementById('btn-view-archives');
    const btnClearData = document.getElementById('btn-clear-data');

    btnArchive.addEventListener('click', () => {
      showLoading('Creating archive file...');
      google.script.run
        .withSuccessHandler((message) => showSuccess('Archive created successfully!'))
        .withFailureHandler((error) => showError(error, 'archive'))
        .ARCHIVE_promptArchiveCurrentYear();
    });

    btnViewArchives.addEventListener('click', () => {
      showLoading('Loading archives...');
      google.script.run
        .withSuccessHandler((message) => showSuccess('Archives loaded'))
        .withFailureHandler((error) => showError(error, 'view archives'))
        .ARCHIVE_showArchiveList();
    });

    btnClearData.addEventListener('click', () => {
      showLoading('Clearing old data...');
      google.script.run
        .withSuccessHandler((message) => showSuccess('Data cleared successfully'))
        .withFailureHandler((error) => showError(error, 'clear data'))
        .ARCHIVE_promptClearOldData();
    });

    // Enhanced status functions
    function showLoading(message) {
      statusMessage.className = 'status-message status-loading';
      statusMessage.innerHTML = '<div class="spinner"></div><span>' + message + '</span>';
      statusMessage.setAttribute('aria-busy', 'true');
      allButtons.forEach(btn => btn.disabled = true);
    }
    
    function showSuccess(message) {
      statusMessage.className = 'status-message status-success';
      statusMessage.innerHTML = '<span>‚úì</span><span>' + message + '</span>';
      statusMessage.setAttribute('aria-busy', 'false');
      updateButtonStates();
      
      // Auto-hide success message after 5 seconds
      setTimeout(() => {
        // Re-check class, in case another message has appeared
        if (statusMessage.classList.contains('status-success')) {
           statusMessage.className = 'status-message hidden';
        }
      }, 5000);
      
      // If we just ran calendar generation, refresh month list
      if (message.includes("liturgical calendar")) {
        monthSelect.innerHTML = '<option value="">Reloading months...</option>';
        google.script.run
          .withSuccessHandler(onMonthsLoaded)
          .withFailureHandler((error) => showError(error, 'calendar'))
          .getMonthsForSidebar();
      }
    }
    
    function showError(error, context) {
      let errorMsg = error.message || error;
      let helpText = '';

      // Add contextual troubleshooting based on operation
      switch(context) {
        case 'calendar':
          helpText = '<br><br><strong>Troubleshooting:</strong><br>' +
                     '‚Ä¢ Check Config sheet has "Year to Schedule" set<br>' +
                     '‚Ä¢ Verify SaintsCalendar sheet exists<br>' +
                     '‚Ä¢ Check CalendarOverrides for conflicts';
          break;
        case 'validation':
          helpText = '<br><br><strong>Tip:</strong> Check the error details above to identify which sheet needs fixing';
          break;
        case 'schedule':
          helpText = '<br><br><strong>Troubleshooting:</strong><br>' +
                     '‚Ä¢ Verify MassTemplates sheet has templates<br>' +
                     '‚Ä¢ Check WeeklyMasses/MonthlyMasses/YearlyMasses sheets<br>' +
                     '‚Ä¢ Ensure selected month is in configured year';
          break;
        case 'form-update':
          helpText = '<br><br><strong>Troubleshooting:</strong><br>' +
                     '‚Ä¢ Verify schedule was generated for this month<br>' +
                     '‚Ä¢ Check Google Form ID in Config sheet<br>' +
                     '‚Ä¢ Ensure proper OAuth permissions for Forms API';
          break;
        case 'timeoffs':
          helpText = '<br><br><strong>Tip:</strong> Verify Timeoffs sheet exists and has the correct columns';
          break;
        case 'assignment':
          helpText = '<br><br><strong>Troubleshooting:</strong><br>' +
                     '‚Ä¢ Ensure Volunteers sheet has active volunteers<br>' +
                     '‚Ä¢ Check volunteers have ministry roles assigned<br>' +
                     '‚Ä¢ Verify schedule was generated first';
          break;
        case 'print':
          helpText = '<br><br><strong>Troubleshooting:</strong><br>' +
                     '‚Ä¢ Verify schedule was generated for this month<br>' +
                     '‚Ä¢ Check LiturgicalCalendar sheet exists<br>' +
                     '‚Ä¢ Ensure assignments were created';
          break;
      }

      statusMessage.className = 'status-message status-error';
      statusMessage.innerHTML = '<span>‚ö†</span><span>Error: ' + errorMsg + helpText + '</span>';
      statusMessage.setAttribute('aria-busy', 'false');
      updateButtonStates();
    }
    
  </script>
</body>
</html>
