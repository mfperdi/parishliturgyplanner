<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Parish Scheduler - Deployment Test</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      padding: 40px;
      max-width: 700px;
      margin: 0 auto;
      background: #fafafa;
      color: #333;
    }
    h1 { color: #4285f4; }
    .status { padding: 12px 16px; margin: 8px 0; border-radius: 6px; }
    .pass { background: #e6f4ea; border-left: 4px solid #34a853; }
    .fail { background: #fce8e6; border-left: 4px solid #ea4335; }
    .loading { background: #e8f0fe; border-left: 4px solid #4285f4; }
    button {
      padding: 10px 20px;
      background: #4285f4;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin: 4px;
    }
    button:hover { background: #3367d6; }
    #results { margin-top: 20px; }
    pre { background: #f5f5f5; padding: 12px; border-radius: 4px; overflow: auto; font-size: 13px; }
  </style>
</head>
<body>
  <h1>Deployment Test Page</h1>
  <p>If you can see this page, the web app deployment is working. This page tests connectivity to the server-side Apps Script functions.</p>

  <div id="results">
    <div class="status pass">
      <strong>HTML Serving:</strong> PASS - This page loaded successfully via HtmlService.
    </div>
  </div>

  <h3>Test Server Functions</h3>
  <button onclick="testGetAllowedSheets()">Test CRUD API</button>
  <button onclick="testApiListener()">Test API Router</button>
  <button onclick="testSpreadsheetAccess()">Test Spreadsheet Access</button>

  <div id="test-results"></div>

  <h3>Deployment Checklist</h3>
  <ul>
    <li><strong>Deploy type:</strong> Must be "Web app" (not "API executable" or "Add-on")</li>
    <li><strong>Execute as:</strong> "Me" (your account) - so the web app has spreadsheet access</li>
    <li><strong>Who has access:</strong> "Anyone" for public, or "Anyone within [org]" for domain-only</li>
    <li><strong>New deployment:</strong> After code changes, create a NEW deployment version (or edit existing and pick new version)</li>
    <li><strong>Authorization:</strong> After first deploy, you must authorize the script when prompted</li>
  </ul>

  <script>
    var resultsDiv = document.getElementById('test-results');

    function addResult(label, status, detail) {
      var div = document.createElement('div');
      div.className = 'status ' + (status === 'PASS' ? 'pass' : 'fail');
      div.innerHTML = '<strong>' + label + ':</strong> ' + status + ' - ' + detail;
      resultsDiv.appendChild(div);
    }

    function addLoading(label) {
      var div = document.createElement('div');
      div.className = 'status loading';
      div.id = 'loading-' + label.replace(/\s/g, '');
      div.innerHTML = '<strong>' + label + ':</strong> Testing...';
      resultsDiv.appendChild(div);
      return div;
    }

    function testGetAllowedSheets() {
      var loader = addLoading('CRUD API');
      google.script.run
        .withSuccessHandler(function(result) {
          loader.remove();
          if (result && result.sheets) {
            addResult('CRUD API', 'PASS', 'Returned ' + result.sheets.length + ' allowed sheets: ' + result.sheets.join(', '));
          } else {
            addResult('CRUD API', 'FAIL', 'Unexpected response: ' + JSON.stringify(result));
          }
        })
        .withFailureHandler(function(err) {
          loader.remove();
          addResult('CRUD API', 'FAIL', err.message || String(err));
        })
        .CRUD_getAllowedSheets();
    }

    function testApiListener() {
      var loader = addLoading('API Router');
      google.script.run
        .withSuccessHandler(function(result) {
          loader.remove();
          if (result && result.sheets) {
            addResult('API Router', 'PASS', 'apiListener responded with ' + result.sheets.length + ' sheets');
          } else if (result && result.error) {
            addResult('API Router', 'FAIL', 'API error: ' + result.error);
          } else {
            addResult('API Router', 'PASS', 'Response: ' + JSON.stringify(result).substring(0, 200));
          }
        })
        .withFailureHandler(function(err) {
          loader.remove();
          addResult('API Router', 'FAIL', err.message || String(err));
        })
        .apiListener(JSON.stringify({ path: 'getAllowedSheets', body: {} }));
    }

    function testSpreadsheetAccess() {
      var loader = addLoading('Spreadsheet Access');
      google.script.run
        .withSuccessHandler(function(result) {
          loader.remove();
          if (result && result.headers) {
            addResult('Spreadsheet Access', 'PASS', 'Config sheet has ' + result.rows.length + ' rows');
          } else {
            addResult('Spreadsheet Access', 'FAIL', 'Unexpected response: ' + JSON.stringify(result));
          }
        })
        .withFailureHandler(function(err) {
          loader.remove();
          addResult('Spreadsheet Access', 'FAIL', err.message || String(err));
        })
        .CRUD_getSheetData('Config');
    }
  </script>
</body>
</html>
